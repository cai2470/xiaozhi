# 小智 (Xiaozhi) AI 助手 - ESP32 固件逻辑剖析

本项目是一个基于 ESP32-S3 的智能语音助手，集成了语音识别 (SR)、流式音频传输、大模型交互 (LLM) 以及基于 MCP 协议的 IoT 设备控制功能。

## 1. 系统架构概览

项目采用分层设计，确保了硬件驱动与业务逻辑的解耦：

- **应用层 (App)**: 负责核心业务逻辑、状态机管理及多任务调度。
- **基础设施层 (Inf)**: 封装具体的硬件功能模块（如 LED、音频编解码、语音识别引擎）。
- **驱动层 (Driver)**: 底层硬件接口（I2C, I2S, SPI, WiFi, WebSocket）。

## 2. 核心模块职责

### 2.1 App 业务模块
- **App_Application**: 系统的“大脑”。负责初始化所有模块，管理全局事件标志组 (`global_event`)，协调 WiFi 连接、设备激活与音频/通信模块的启动。
- **App_Communication**: 通信中枢。处理 WebSocket 协议，实现 MCP (Model Context Protocol) 协议对接，负责 Session 管理及 IoT 指令的中转。
- **App_Audio**: 音频流水线。管理从麦克风采集到语音识别，再到 Opus 编码上传，以及下行音频流解码播放的全过程。
- **App_Display**: UI 表现层。基于 LVGL 实现，负责 Emoji 表情、实时状态文字、WiFi 信号强度及二维码的显示。
- **App_OTA**: 设备生命周期管理。负责设备激活、获取服务器令牌 (Token) 及固件更新。

### 2.2 Inf 硬件接口层
- **Inf_SR**: 语音识别引擎。负责唤醒词检测 (WakeNet) 和端点检测 (VAD)。
- **Inf_IOT**: IoT 逻辑适配。定义设备能力描述符 (Descriptors)，解析 AI 下发的控制指令并驱动硬件。
- **Inf_Led**: 硬件执行器。控制 RGB LED 的开关与颜色。
- **Inf_Encoder/Decoder**: 音频编解码。负责 PCM 与 Opus 格式的互相转换。

## 3. 核心逻辑流程

### 3.1 启动与激活流程
1. **WiFi 配网**: `Driver_WIFI` 启动，若未配网则显示二维码。
2. **设备激活**: `App_OTA` 通过 HTTP POST 向服务器发送设备 ID，换取 `websocket_url` 和 `token`。
3. **建立连接**: `App_Communication` 启动 WebSocket，发送 `hello` 消息并声明支持 `mcp`。
4. **同步上下文**: 收到 `hello` 响应后，立即通过 `App_Communication_PushStatus` 上报当前硬件状态。

### 3.2 语音交互流水线 (上行)
`I2S 采集` -> `es8311_to_sr_buffer` -> `Inf_SR (VAD/唤醒检测)` -> `sr_to_encoder_buff` -> `Inf_Encoder (Opus)` -> `encoder_to_ws_buff` -> `WebSocket 发送`

### 3.3 语音交互流水线 (下行)
`WebSocket 接收` -> `ws_to_decoder_buff` -> `Inf_Decoder (Opus->PCM)` -> `I2S 播放 (ES8311)`

### 3.4 IoT 控制逻辑 (MCP)
1. **能力上报**: 设备连接时发送 `descriptors`，告知 AI 它拥有控制 "Light" 的能力。
2. **指令下发**: 用户说“开灯”，服务器下发 `type: "iot"` 消息。
3. **指令执行**: `App_Communication` 调用 `Inf_IOT_HandleCommand`，最终触发 `Inf_Led_Open`。
4. **状态闭环**: 指令执行后，调用 `App_Communication_PushStatus` 回传最新状态，确保 AI 端的上下文同步。

## 4. 内存与存储设计

### 4.1 内存分配 (PSRAM)
由于音频编解码和 LVGL 渲染对内存需求巨大，项目大量使用外部 PSRAM (`MALLOC_CAP_SPIRAM`)：
- 所有的 `RingBuffer` 均分配在 PSRAM。
- LVGL 渲染缓冲区及任务堆栈位于 PSRAM。
- 音频编解码的临时缓冲区位于 PSRAM。

### 4.2 Flash 分区 (`partitions.csv`)
- **nvs**: 存储 WiFi 信息、UUID 及用户配置。
- **factory**: 存放 4MB 的应用程序固件。
- **model**: 存放语音识别所需的声学模型数据。

## 5. 关键技术点

- **VAD 状态机**: 通过 `App_Application_VadChange` 实现自动录音切换，减少无效数据上传。
- **异步桥接**: `ws-mcp-bridge.js` 解决了本地 MCP 客户端与远程 WSS 服务端的协议转换。
- **线程安全**: LVGL 操作严格遵循 `lvgl_port_lock` 机制，确保多任务环境下 UI 刷新的稳定性。

---
*Xiaozhi Project - 打造最懂你的 AI 硬件*
